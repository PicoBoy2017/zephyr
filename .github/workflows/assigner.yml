name: Pull Request Assigner

on:
  pull_request_target:
    types:
    - opened
    - synchronize
    - reopened
    - ready_for_review
    branches:
    - main
    - adi-main*
    - collab-*
    - v*-branch
  issues:
    types:
    - labeled

jobs:
  assignment:
    name: Pull Request Assignment
    if: github.event.pull_request.draft == false
    runs-on: ses-edi-build-lu-x64-10

    steps:
    - name: Remove Possible Existing Access Token
      continue-on-error: true
      run: |
        # Token is generated at the run time and at the end of process it is expires,
        # storing it in global config causes duplication line in config file
        # so that possible existing one shall be deleted before generating new one
        # otherwiser autantication will be failed.
        existingTokenURL=$(git config --global --get-regexp url.*@github.com/.insteadOf)
        echo "All Token:${existingTokenURL}"
        for item in $(echo ${existingTokenURL}); do
          if [ ${item} == "https://github.com/" ]; then
            continue
          fi
          echo "Removing: ${item}"
          git config --global --unset-all "${item}"
        done

    - name: Get Access Token
      id: generate-github-app-token
      uses: adi-innersource/shared-actions/generate-github-token@v1
      with:
        app-id: ${{ secrets.TOKEN_GENERATOR_APP_ID }}
        private-key: ${{ secrets.TOKEN_GENERATOR_APP_PRIVATE_KEY }}
        organization: ${{ github.repository_owner }}
        repositories: |
          zephyr
          zephyr-runner-configurations
          hal_adi
          packetcraft-adi
          trusted-firmware-m
          trusted-firmware-a
          tf-m-tests
          psa-arch-tests

    - name: Install Python dependencies
      run: |
        sudo pip3 install -U setuptools wheel pip
        pip3 install -U PyGithub>=1.55 west

    - name: Check out source code
      uses: actions/checkout@v4

    - name: Run assignment script
      env:
        GITHUB_TOKEN: ${{ steps.generate-github-app-token.outputs.access-token }}
      run: |
        FLAGS="-v"
        FLAGS+=" -o ${{ github.event.repository.owner.login }}"
        FLAGS+=" -r ${{ github.event.repository.name }}"
        FLAGS+=" -M MAINTAINERS.yml"
        if [ "${{ github.event_name }}" = "pull_request_target" ]; then
            FLAGS+=" -P ${{ github.event.pull_request.number }}"
        elif [ "${{ github.event_name }}" = "issues" ]; then
            FLAGS+=" -I ${{ github.event.issue.number }}"
        elif [ "${{ github.event_name }}" = "schedule" ]; then
            FLAGS+=" --modules"
        else
          echo "Unknown event: ${{ github.event_name }}"
          exit 1
        fi

        python3 scripts/set_assignees.py $FLAGS
